# name: Deploy to Cloud Run (Image)

# on:
#   push:
#     branches: ["main"]
#   workflow_dispatch:

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read
#       id-token: write

#     env:
#       PROJECT_ID: careerquest-486610
#       REGION: asia-northeast3
#       SERVICE: career-quest
#       AR_REPO: cloud-run
#       IMAGE_NAME: career-quest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Auth to Google Cloud (OIDC)
#         uses: google-github-actions/auth@v3
#         with:
#           workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
#           service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
#           project_id: ${{ env.PROJECT_ID }}

#       - name: Setup gcloud
#         uses: google-github-actions/setup-gcloud@v2
#         with:
#           project_id: ${{ env.PROJECT_ID }}

#       - name: Configure Docker auth for Artifact Registry
#         run: |
#           gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

#       - name: Ensure Artifact Registry repo exists
#         run: |
#           set -e
#           if ! gcloud artifacts repositories describe "${AR_REPO}" \
#             --location "${REGION}" --project "${PROJECT_ID}" >/dev/null 2>&1; then
#             gcloud artifacts repositories create "${AR_REPO}" \
#               --repository-format=docker \
#               --location "${REGION}" \
#               --project "${PROJECT_ID}" \
#               --description="Docker images for Cloud Run"
#           fi

#       - name: Build & Push image
#         env:
#           IMAGE_URI: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
#         run: |
#           echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
#           docker build -t "$IMAGE_URI" .
#           docker push "$IMAGE_URI"

#       - name: Deploy to Cloud Run (image)
#         run: |
#           gcloud run deploy "${SERVICE}" \
#             --image "${IMAGE_URI}" \
#             --region "${REGION}" \
#             --project "${PROJECT_ID}" \
#             --quiet

#       - name: Show URL
#         run: |
#           gcloud run services describe "${SERVICE}" \
#             --region "${REGION}" \
#             --project "${PROJECT_ID}" \
#             --format="value(status.url)"
